# PokerAI Web Backend & Other Serverless Functions

This repository contains a dockerized express server that serves as the backend for the PokerAI web application.


## Getting Started

Install all dependencies:

```bash
cd web-backend
bun install
```

Run the server in dev mode:

```bash
bun dev
```

The server will be running on `http://localhost:<PORT FROM ENV>`.

API specification can be found at `http://localhost:<PORT FROM ENV>/api-spec`.

To build the server:

```bash
bun build
```

### Project Structure

```
.
├── README.md               # This file
└── web-backend             # Express server
    ├── Dockerfile          # Dockerfile for the express server
    ├── api                 # API specification and autogenerated code
    │   ├── generated
    │   └── src
    ├── package.json        # Dependencies and scripts
    ├── src                 # Source code
    │   ├── app.ts          # Express app
    │   ├── config          # Configuration files
    │   ├── controllers     # Request handlers
    │   ├── middleware      # Middleware functions
    │   ├── routes          # Route definitions
    │   ├── server.ts       # Server entry point
    │   └── services        # Business logic
    ├── tsconfig.json
    └── pnpm-lock.yaml
```

### Environment Variables

Create a `.env` file in the root of the project with the following environment variables:

```
PORT=8080
DATABASE_URL="postgresql://your_database_user:your_secure_password@localhost:5432/pokerbots_dev?schema=public"
DBUSER=your_database_user
DBPASSWORD=your_secure_password
```

### Database

The server uses a PostgreSQL database to store data. You can run a PostgreSQL server locally for developing if you have docker installed. Run:

```bash
bun run db:start
```

to start the database and:

```bash
bun run db:stop
```
to stop the database.

## Datamodel

The data is stored in a PostgreSQL DB, the schema is as follows:

```mermaid
erDiagram
    UserDao {
        Int id PK
        String email
        PermissionLevel permissionLevel
        Int teamId FK
        Boolean isBlocked
    }
    
    TeamDao {
        Int id PK
        String name
        Boolean isDeleted
        Int activeBotId FK
        Int elo
    }

    TeamMatchDao {
        Int id PK
        Int matchId FK
        Int teamId FK
        Int bankroll
        Int botId FK
    }

    MatchDao {
        Int matchId PK
        DateTime timestamp
        MatchStatus matchStatus
        Int matchRequestId FK
    }

    TeamInviteDao {
        Int id PK
        Int teamId FK
        DateTime sendAt
        Int userId FK
    }

    MatchRequestDao {
        Int id PK
        Int requestingTeamId FK
        Int requestedTeamId FK
        DateTime sendAt
        Boolean isAccepted
    }

    BotDao {
        Int id PK
        Int version
        Int teamId FK
        DateTime created
        String storageLocation
        Int activeTeamId FK
    }

    UserDao ||--o{ TeamDao : "team"
    TeamDao ||--o{ UserDao : "members"
    UserDao ||--o{ TeamInviteDao : "invites"
    TeamDao ||--o{ TeamInviteDao : "invites"
    TeamDao ||--o{ TeamMatchDao : "teamMatches"
    TeamDao ||--o{ MatchRequestDao : "requestingMatches"
    TeamDao ||--o{ MatchRequestDao : "requestedMatches"
    TeamMatchDao ||--|| MatchDao : "match"
    TeamMatchDao ||--|| BotDao : "bot"
    TeamInviteDao ||--|| UserDao : "user"
    TeamInviteDao ||--|| TeamDao : "team"
    MatchDao ||--|| MatchRequestDao : "matchRequest"
    MatchRequestDao ||--|| TeamDao : "requestingTeam"
    MatchRequestDao ||--|| TeamDao : "requestedTeam"
    BotDao ||--|| TeamDao : "team"
    BotDao ||--o| TeamDao : "activeBot"

```